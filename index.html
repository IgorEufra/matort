<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAF - Sistema de Materiais Ortop√©dicos (Cloud)</title>

    <!-- Firebase (apenas Firestore) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #1a365d;
            --secondary: #4a5568;
            --accent: #2b6cb0;
            --light: #f7fafc;
            --success: #38a169;
            --warning: #e53e3e;
            --text: #2d3748;
            --online: #38a169;
            --offline: #e53e3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 0 0 10px 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .sync-status {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online {
            background-color: var(--online);
        }

        .status-offline {
            background-color: var(--offline);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Tela Principal */
        #main-screen {
            display: block;
        }

        .category-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .category-btn,
        .subcategory-btn {
            padding: 12px 20px;
            background-color: white;
            border: 2px solid var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 150px;
        }

        .category-btn:hover,
        .subcategory-btn:hover {
            background-color: var(--accent);
            color: white;
        }

        .category-btn.active,
        .subcategory-btn.active {
            background-color: var(--accent);
            color: white;
        }

        .back-btn {
            padding: 10px 15px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .totem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .material-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .material-card:hover {
            transform: translateY(-5px);
        }

        .material-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background-color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .material-info {
            padding: 15px;
            flex-grow: 1;
        }

        .material-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .material-category {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .material-quantity {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }

        .quantity-zero {
            color: var(--warning);
        }

        .material-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .btn-add {
            background-color: var(--success);
            color: white;
            flex: 1;
            margin-right: 5px;
        }

        .btn-remove {
            background-color: var(--warning);
            color: white;
            flex: 1;
            margin-left: 5px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .btn:disabled {
            background-color: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
        }

        .admin-btn:hover {
            background-color: var(--primary);
        }

        /* Tela de Administra√ß√£o */
        #admin-screen {
            display: none;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn-export {
            background-color: var(--success);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-copy {
            background-color: var(--accent);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
            padding: 12px 20px;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .materials-list {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .material-item:last-child {
            border-bottom: none;
        }

        .material-details {
            flex: 1;
        }

        .material-actions-admin {
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            background-color: var(--accent);
            color: white;
        }

        .btn-delete {
            background-color: var(--warning);
            color: white;
        }

        /* Modal de PIN */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal h2 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .feedback {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }

        .success {
            background-color: #c6f6d5;
            color: #22543d;
        }

        .error {
            background-color: #fed7d7;
            color: #742a2a;
        }

        .loading {
            background-color: #bee3f8;
            color: #2a4365;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .totem-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .material-actions-admin {
                flex-direction: column;
            }

            .category-navigation {
                flex-direction: column;
            }

            .export-buttons {
                flex-direction: column;
            }

            .sync-status {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }
        }
    </style>
</head>

<body>
    <!-- Tela Principal -->
    <div id="main-screen">
        <header>
            <div class="container">
                <h1>FAF - Sistema de Materiais Ortop√©dicos</h1>
                <p class="subtitle">Controle de Estoque - Sincronizado em Nuvem</p>
                <div class="sync-status">
                    <div class="status-dot status-offline" id="status-dot"></div>
                    <span id="status-text">Conectando...</span>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="feedback-message" class="feedback" style="display: none;"></div>

            <!-- Navega√ß√£o por Categorias -->
            <div id="category-view">
                <h2>Selecione uma Categoria</h2>
                <div class="category-navigation" id="categories-container">
                    <!-- As categorias ser√£o geradas dinamicamente aqui -->
                </div>
            </div>

            <!-- Navega√ß√£o por Subcategorias -->
            <div id="subcategory-view" style="display: none;">
                <button class="back-btn" id="back-to-categories">‚Üê Voltar para Categorias</button>
                <h2 id="subcategory-title">Selecione uma Subcategoria</h2>
                <div class="category-navigation" id="subcategories-container">
                    <!-- As subcategorias ser√£o geradas dinamicamente aqui -->
                </div>
            </div>

            <!-- Lista de Materiais -->
            <div id="materials-view" style="display: none;">
                <button class="back-btn" id="back-to-subcategories">‚Üê Voltar para Subcategorias</button>
                <h2 id="materials-title">Materiais</h2>
                <div class="totem-grid" id="materials-grid">
                    <!-- Os cards de materiais ser√£o gerados dinamicamente aqui -->
                </div>
            </div>
        </div>

        <div class="admin-btn" id="admin-access-btn" title="Acesso Administrativo">‚öôÔ∏è</div>
    </div>

    <!-- Tela de Administra√ß√£o -->
    <div id="admin-screen">
        <header>
            <div class="container">
                <h1>FAF - √Årea Administrativa</h1>
                <p class="subtitle">Cadastro e Gerenciamento de Materiais</p>
                <div class="sync-status">
                    <div class="status-dot status-offline" id="admin-status-dot"></div>
                    <span id="admin-status-text">Conectando...</span>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="admin-header">
                <h2>Gerenciar Materiais</h2>
                <button class="btn btn-secondary" id="back-to-main">Voltar ao Painel Principal</button>
            </div>

            <!-- Bot√µes de Exporta√ß√£o -->
            <div class="export-buttons">
                <button class="btn btn-export" id="export-pdf">
                    üìÑ Exportar PDF
                </button>
                <button class="btn btn-whatsapp" id="share-whatsapp">
                    üì± Compartilhar Resumo
                </button>
                <button class="btn btn-copy" id="copy-summary">
                    üìã Copiar Resumo
                </button>
            </div>

            <div class="form-container">
                <h3 id="form-title">Cadastrar Novo Material</h3>
                <form id="material-form">
                    <input type="hidden" id="material-id">

                    <div class="form-group">
                        <label for="material-name">Nome do Material</label>
                        <input type="text" id="material-name" required>
                    </div>

                    <div class="form-group">
                        <label for="material-category">Categoria</label>
                        <select id="material-category" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="material-subcategory">Subcategoria</label>
                        <select id="material-subcategory" required>
                            <option value="">Selecione uma subcategoria</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="material-quantity">Quantidade Inicial</label>
                        <input type="number" id="material-quantity" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="material-image">Imagem (URL)</label>
                        <input type="text" id="material-image" placeholder="https://exemplo.com/imagem.jpg">
                    </div>

                    <div class="form-group">
                        <label for="material-notes">Observa√ß√µes</label>
                        <textarea id="material-notes" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submit-btn">Cadastrar Material</button>
                    <button type="button" class="btn btn-secondary" id="cancel-edit" style="display: none;">Cancelar
                        Edi√ß√£o</button>
                </form>
            </div>

            <div class="materials-list">
                <h3>Materiais Cadastrados</h3>
                <div id="materials-list-container">
                    <!-- Lista de materiais ser√° gerada aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de PIN -->
    <div class="modal" id="pin-modal">
        <div class="modal-content">
            <h2>Acesso Administrativo</h2>
            <p>Digite o PIN para acessar a √°rea de administra√ß√£o:</p>
            <div class="form-group">
                <input type="password" id="pin-input" placeholder="PIN de acesso">
            </div>
            <div class="form-group">
                <button class="btn btn-primary" id="confirm-pin">Confirmar</button>
                <button class="btn btn-secondary" id="cancel-pin">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURA√á√ÉO FIREBASE - SUBSTITUA COM SEUS DADOS!
        // =============================================
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDKDNK_PpL53jzKWVuzKjqiy_ovMOSWohM",
            authDomain: "mat-ort.firebaseapp.com",
            projectId: "mat-ort",
            storageBucket: "mat-ort.firebasestorage.app",
            messagingSenderId: "46791927003",
            appId: "1:46791927003:web:8341303577ba5b1cd218fe"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Inicializar Firebase (apenas Firestore)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Dados de categorias e subcategorias
        const categoriesData = {
            "Mobilidade": {
                "Andadores": ["Andador Adulto", "Andador Infantil"],
                "Bengalas": ["Bengala Adulto", "Bengala Infantil", "Bengala 4 Pontas"],
                "Cadeiras de Rodas": ["Cadeira de Rodas Adulto at√© 90 kg", "Cadeira de Rodas Adulto 120kg",
                    "Cadeira de Rodas Adulto Semi Obeso", "Cadeira de Rodas Infantil",
                    "Cadeira de Rodas de Eleva√ß√£o Perna", "Cadeira de Rodas de Transfer√™ncia Adulto"],
                "Muletas": ["Muletas Axilar Adulto", "Muleta Axilar Infantil",
                    "Muletas Canadense Adulto", "Muleta Canadense Infantil"],
                "Cadeiras de Banho": ["Cadeira de Banho at√© 85 kg", "Cadeira de Banho at√© 100 kg"]
            },
            "Imobiliza√ß√£o": {
                "Colares Cervicais": ["Colar Cervical para TQT EVA / Polietileno", "Colar Cervical EVA/Polietileno"],
                "Joelhos": ["Joelheira", "Joelheira Articulada", "Imobilizador de Joelho"],
                "Tornozeleiras": ["Estabilizador de Tornozelo"],
                "Punhos": ["Tala para Punho Direito", "Tala para Punho Esquerdo", "Tala para Punho e Polegar"],
                "Coletes": ["Colete Jewett", "Colete Putti Baixo", "Colete Putti Alto"],
                "Outros Imobiliza√ß√£o": ["Suporte de Ombro"]
            },
            "Suporte e Conforto": {
                "Cal√ßados": ["Sand√°lia Baruk Plana", "Sand√°lia Baruk Retrop√©", "Robofoot"],
                "Cintas": ["Cinta Abdominal 100 x 20cm"],
                "Almofadas": ["Almofada para Conforto da Pr√≥stata", "Cunha Almofadada"],
                "Tipoias": ["Tipoia M Bilateral", "Tipoia G Bilateral", "Tipoia P Bilateral", "Tipoia Infantil"]
            },
            "Equipamentos Hospitalares": {
                "Camas": ["Cama Hospitalar"],
                "Colch√µes": ["Colch√£o Caixa de Ovo", "Colch√£o Hospitalar", "Colch√£o Pneum√°tico"],
                "Respirat√≥rios": ["Cilindro de Oxig√™nio Hospitalar", "Inalador", "Respirat√≥rio"],
                "Equipamentos Diversos": ["Aspirador Cir√∫rgico", "Bomba a V√°cuo Aspiradora", "Bomba de Press√£o",
                    "Guincho Hospitalar", "Suporte para Soro", "Term√¥metro Sensor", "Papagaio"]
            },
            "Insumos": {
                "Fraldas": ["Fralda Descart√°vel Adulto Tamanho G", "Fralda Descart√°vel Adulto Tamanho M",
                    "Fralda Descart√°vel Adulto Tamanho XG"],
                "Sondas": ["Sonda Uretral"],
                "Outros Insumos": ["Ap. Press√£o Digital", "Calha para P√©", "Cesta B√°sica", "Comadre"]
            }
        };

        // PIN de acesso
        const ADMIN_PIN = "1234";

        // Elementos da DOM
        const mainScreen = document.getElementById('main-screen');
        const adminScreen = document.getElementById('admin-screen');
        const adminAccessBtn = document.getElementById('admin-access-btn');
        const backToMainBtn = document.getElementById('back-to-main');
        const pinModal = document.getElementById('pin-modal');
        const pinInput = document.getElementById('pin-input');
        const confirmPinBtn = document.getElementById('confirm-pin');
        const cancelPinBtn = document.getElementById('cancel-pin');
        const materialsGrid = document.getElementById('materials-grid');
        const materialForm = document.getElementById('material-form');
        const materialsListContainer = document.getElementById('materials-list-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const materialIdInput = document.getElementById('material-id');
        const categorySelect = document.getElementById('material-category');
        const subcategorySelect = document.getElementById('material-subcategory');

        // Elementos de exporta√ß√£o
        const exportPdfBtn = document.getElementById('export-pdf');
        const shareWhatsappBtn = document.getElementById('share-whatsapp');
        const copySummaryBtn = document.getElementById('copy-summary');

        // Elementos de status
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const adminStatusDot = document.getElementById('admin-status-dot');
        const adminStatusText = document.getElementById('admin-status-text');

        // Elementos de navega√ß√£o
        const categoryView = document.getElementById('category-view');
        const subcategoryView = document.getElementById('subcategory-view');
        const materialsView = document.getElementById('materials-view');
        const categoriesContainer = document.getElementById('categories-container');
        const subcategoriesContainer = document.getElementById('subcategories-container');
        const backToCategoriesBtn = document.getElementById('back-to-categories');
        const backToSubcategoriesBtn = document.getElementById('back-to-subcategories');
        const subcategoryTitle = document.getElementById('subcategory-title');
        const materialsTitle = document.getElementById('materials-title');

        // Estado da aplica√ß√£o
        let materials = [];
        let editingMaterialId = null;
        let currentCategory = null;
        let currentSubcategory = null;
        let isOnline = false;

        // =============================================
        // INICIALIZA√á√ÉO FIREBASE E SISTEMA
        // =============================================

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Iniciando sistema com Firebase Firestore...");
            initializeFirebase();
            setupEventListeners();
            populateCategorySelects();
        });

        // Inicializar Firebase e escutar mudan√ßas
        function initializeFirebase() {
            showFeedback("Conectando com a nuvem...", "loading");

            // Escutar mudan√ßas em tempo real
            db.collection("materials").onSnapshot((snapshot) => {
                materials = [];
                snapshot.forEach((doc) => {
                    materials.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                updateSyncStatus(true);
                showFeedback("Dados sincronizados com sucesso!", "success");

                // Atualizar interface
                renderCategories();
                if (currentCategory && currentSubcategory) {
                    renderMaterialsBySubcategory(currentCategory, currentSubcategory);
                }

                console.log("Dados carregados do Firebase:", materials.length, "materiais");

            }, (error) => {
                console.error("Erro ao conectar com Firebase:", error);
                updateSyncStatus(false);
                showFeedback("Erro de conex√£o. Usando modo offline.", "error");

                // Tentar carregar do localStorage como fallback
                loadFromLocalStorage();
            });
        }

        // Atualizar status de sincroniza√ß√£o
        function updateSyncStatus(online) {
            isOnline = online;

            if (online) {
                statusDot.className = "status-dot status-online";
                statusText.textContent = "Sincronizado";
                adminStatusDot.className = "status-dot status-online";
                adminStatusText.textContent = "Sincronizado";
            } else {
                statusDot.className = "status-dot status-offline";
                statusText.textContent = "Offline";
                adminStatusDot.className = "status-dot status-offline";
                adminStatusText.textContent = "Offline";
            }
        }

        // Carregar do localStorage como fallback
        function loadFromLocalStorage() {
            const storedMaterials = localStorage.getItem('faf-materials');
            if (storedMaterials) {
                try {
                    materials = JSON.parse(storedMaterials);
                    renderCategories();
                    showFeedback("Modo offline ativado. Dados locais carregados.", "loading");
                } catch (e) {
                    console.error("Erro ao carregar do localStorage:", e);
                }
            }
        }

        // Salvar localmente como backup
        function saveToLocalStorage() {
            try {
                localStorage.setItem('faf-materials', JSON.stringify(materials));
            } catch (e) {
                console.error("Erro ao salvar no localStorage:", e);
            }
        }

        // =============================================
        // FUN√á√ïES FIREBASE - CRUD (APENAS FIRESTORE)
        // =============================================

        // Adicionar/Atualizar material no Firebase
        async function saveMaterial(material) {
            try {
                if (material.id && material.id.startsWith('local-')) {
                    // √â um material novo
                    const docRef = await db.collection("materials").add({
                        nome: material.nome,
                        categoria: material.categoria,
                        subcategoria: material.subcategoria,
                        quantidade: material.quantidade,
                        imagem: material.imagem,
                        observacoes: material.observacoes,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return docRef.id;
                } else {
                    // Atualizar material existente
                    await db.collection("materials").doc(material.id).update({
                        nome: material.nome,
                        categoria: material.categoria,
                        subcategoria: material.subcategoria,
                        quantidade: material.quantidade,
                        imagem: material.imagem,
                        observacoes: material.observacoes,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return material.id;
                }
            } catch (error) {
                console.error("Erro ao salvar no Firebase:", error);
                throw error;
            }
        }

        // Deletar material do Firebase
        async function deleteMaterialFromFirebase(id) {
            try {
                await db.collection("materials").doc(id).delete();
            } catch (error) {
                console.error("Erro ao deletar do Firebase:", error);
                throw error;
            }
        }

        // =============================================
        // FUN√á√ïES DE EXPORTA√á√ÉO (SEM STORAGE)
        // =============================================

        // Exportar PDF local
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // T√≠tulo
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text("RELAT√ìRIO FAF - MATERIAIS ORTOP√âDICOS", 105, 15, { align: 'center' });

            // Data
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, 105, 25, { align: 'center' });

            // Resumo
            let yPosition = 40;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("RESUMO DO ESTOQUE", 20, yPosition);

            yPosition += 10;
            doc.setFontSize(10);

            // Agrupar por categoria
            const categorias = {};
            materials.forEach(material => {
                if (!categorias[material.categoria]) {
                    categorias[material.categoria] = [];
                }
                categorias[material.categoria].push(material);
            });

            // Adicionar tabela de resumo
            const tableData = [];
            Object.keys(categorias).forEach(categoria => {
                const total = categorias[categoria].reduce((sum, item) => sum + item.quantidade, 0);
                tableData.push([categoria, categorias[categoria].length, total]);
            });

            doc.autoTable({
                startY: yPosition,
                head: [['Categoria', 'Itens', 'Total Unidades']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [26, 54, 93] },
                margin: { top: 10 }
            });

            yPosition = doc.lastAutoTable.finalY + 15;

            // Detalhamento por categoria
            Object.keys(categorias).forEach(categoria => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFontSize(12);
                doc.setTextColor(26, 54, 93);
                doc.text(`CATEGORIA: ${categoria}`, 20, yPosition);
                yPosition += 8;

                const categoriaData = categorias[categoria].map(item => [
                    item.nome,
                    item.subcategoria,
                    item.quantidade.toString(),
                    item.quantidade === 0 ? 'ESGOTADO' : 'DISPON√çVEL'
                ]);

                doc.autoTable({
                    startY: yPosition,
                    head: [['Material', 'Subcategoria', 'Quantidade', 'Status']],
                    body: categoriaData,
                    theme: 'grid',
                    headStyles: { fillColor: [43, 108, 176] },
                    styles: { fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 60 },
                        1: { cellWidth: 40 },
                        2: { cellWidth: 25 },
                        3: { cellWidth: 30 }
                    }
                });

                yPosition = doc.lastAutoTable.finalY + 10;
            });

            // Salvar PDF
            doc.save(`relatorio-faf-${new Date().toISOString().split('T')[0]}.pdf`);
            showFeedback("PDF gerado com sucesso! Baixe e compartilhe manualmente.", "success");
        }

        // Compartilhar resumo via WhatsApp
        function shareSummaryViaWhatsApp() {
            let texto = "üìã *RELAT√ìRIO FAF - ESTOQUE DE MATERIAIS ORTOP√âDICOS*%0A%0A";

            // Resumo por categoria
            const categorias = {};
            materials.forEach(material => {
                if (!categorias[material.categoria]) {
                    categorias[material.categoria] = [];
                }
                categorias[material.categoria].push(material);
            });

            Object.keys(categorias).forEach(categoria => {
                const total = categorias[categoria].reduce((sum, item) => sum + item.quantidade, 0);
                texto += `üè∑Ô∏è *${categoria}:* ${categorias[categoria].length} itens, ${total} unidades%0A`;
            });

            texto += `%0AüìÖ *Data:* ${new Date().toLocaleDateString('pt-BR')}`;
            texto += `%0A‚è∞ *Hora:* ${new Date().toLocaleTimeString('pt-BR')}`;
            texto += `%0A%0Aüí° *Itens em falta:* ${materials.filter(m => m.quantidade === 0).length}`;
            texto += `%0Aüì¶ *Total de itens:* ${materials.length}`;
            texto += `%0A%0A_Sistema FAF - Sincronizado em Nuvem_`;
            texto += `%0A%0Aüíæ *PDF dispon√≠vel no sistema para download detalhado*`;

            const url = `https://wa.me/?text=${texto}`;
            window.open(url, '_blank');
            showFeedback("WhatsApp aberto com o resumo!", "success");
        }

        // Copiar resumo para √°rea de transfer√™ncia
        function copySummaryToClipboard() {
            let texto = "RELAT√ìRIO FAF - ESTOQUE\n\n";

            const categorias = {};
            materials.forEach(material => {
                if (!categorias[material.categoria]) {
                    categorias[material.categoria] = [];
                }
                categorias[material.categoria].push(material);
            });

            Object.keys(categorias).forEach(categoria => {
                texto += `${categoria}:\n`;
                categorias[categoria].forEach(material => {
                    const status = material.quantidade === 0 ? '‚ùå ESGOTADO' : '‚úÖ';
                    texto += `  ${status} ${material.nome}: ${material.quantidade} unidades\n`;
                });
                texto += '\n';
            });

            texto += `Data: ${new Date().toLocaleDateString('pt-BR')}\n`;
            texto += `Hora: ${new Date().toLocaleTimeString('pt-BR')}\n`;
            texto += `Total de itens: ${materials.length}\n`;
            texto += `Itens em falta: ${materials.filter(m => m.quantidade === 0).length}\n`;
            texto += `Sistema FAF - Sincronizado em Nuvem`;

            navigator.clipboard.writeText(texto).then(() => {
                showFeedback("Resumo copiado para a √°rea de transfer√™ncia!", "success");
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = texto;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showFeedback("Resumo copiado para a √°rea de transfer√™ncia!", "success");
            });
        }

        // =============================================
        // CONFIGURA√á√ÉO DE EVENT LISTENERS
        // =============================================

        function setupEventListeners() {
            adminAccessBtn.addEventListener('click', showPinModal);
            backToMainBtn.addEventListener('click', showMainScreen);
            confirmPinBtn.addEventListener('click', verifyPin);
            cancelPinBtn.addEventListener('click', hidePinModal);
            materialForm.addEventListener('submit', handleMaterialSubmit);
            cancelEditBtn.addEventListener('click', cancelEdit);
            backToCategoriesBtn.addEventListener('click', showCategoryView);
            backToSubcategoriesBtn.addEventListener('click', showSubcategoryView);

            // Event listeners para exporta√ß√£o
            exportPdfBtn.addEventListener('click', exportToPDF);
            shareWhatsappBtn.addEventListener('click', shareSummaryViaWhatsApp);
            copySummaryBtn.addEventListener('click', copySummaryToClipboard);

            // Atalho de teclado para acesso administrativo (Ctrl+Alt+F)
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey && e.altKey && e.key === 'F') {
                    e.preventDefault();
                    showPinModal();
                }
            });

            // Atualizar subcategorias quando a categoria for alterada
            categorySelect.addEventListener('change', function () {
                updateSubcategorySelect(this.value);
            });
        }

        // =============================================
        // FUN√á√ïES EXISTENTES DO SISTEMA
        // =============================================

        // Renderizar categorias na tela principal
        function renderCategories() {
            categoriesContainer.innerHTML = '';

            Object.keys(categoriesData).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = category;
                btn.addEventListener('click', function () {
                    selectCategory(category);
                });

                categoriesContainer.appendChild(btn);
            });
        }

        // Selecionar uma categoria
        function selectCategory(category) {
            currentCategory = category;
            renderSubcategories(category);
            showSubcategoryView();
        }

        // Renderizar subcategorias
        function renderSubcategories(category) {
            subcategoriesContainer.innerHTML = '';
            subcategoryTitle.textContent = `Categoria: ${category}`;

            if (categoriesData[category]) {
                Object.keys(categoriesData[category]).forEach(subcategory => {
                    const btn = document.createElement('button');
                    btn.className = 'subcategory-btn';
                    btn.textContent = subcategory;
                    btn.addEventListener('click', function () {
                        selectSubcategory(subcategory);
                    });

                    subcategoriesContainer.appendChild(btn);
                });
            }
        }

        // Selecionar uma subcategoria
        function selectSubcategory(subcategory) {
            currentSubcategory = subcategory;
            renderMaterialsBySubcategory(currentCategory, subcategory);
            showMaterialsView();
        }

        // Renderizar materiais por subcategoria
        function renderMaterialsBySubcategory(category, subcategory) {
            materialsGrid.innerHTML = '';
            materialsTitle.textContent = `${category} - ${subcategory}`;

            const filteredMaterials = materials.filter(m =>
                m.categoria === category && m.subcategoria === subcategory
            );

            if (filteredMaterials.length === 0) {
                materialsGrid.innerHTML = '<p>Nenhum material encontrado nesta subcategoria.</p>';
                return;
            }

            filteredMaterials.forEach(material => {
                const card = document.createElement('div');
                card.className = 'material-card';

                const imageContent = material.imagem
                    ? `<img src="${material.imagem}" alt="${material.nome}" class="material-image">`
                    : `<div class="material-image">ü©∫</div>`;

                card.innerHTML = `
                    ${imageContent}
                    <div class="material-info">
                        <div class="material-name">${material.nome}</div>
                        <div class="material-category">${material.categoria} - ${material.subcategoria}</div>
                        <div class="material-quantity ${material.quantidade === 0 ? 'quantity-zero' : ''}">
                            ${material.quantidade} ${material.quantidade === 1 ? 'unidade' : 'unidades'}
                        </div>
                        <div class="material-actions">
                            <button class="btn btn-add" data-id="${material.id}">+ Adicionar</button>
                            <button class="btn btn-remove" data-id="${material.id}" ${material.quantidade === 0 ? 'disabled' : ''}>- Retirar</button>
                        </div>
                    </div>
                `;

                materialsGrid.appendChild(card);
            });

            // Adicionar event listeners aos bot√µes
            document.querySelectorAll('.btn-add').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = this.getAttribute('data-id');
                    updateQuantity(id, 1);
                });
            });

            document.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = this.getAttribute('data-id');
                    updateQuantity(id, -1);
                });
            });
        }

        // Atualizar quantidade de um material
        async function updateQuantity(id, change) {
            const materialIndex = materials.findIndex(m => m.id === id);
            if (materialIndex !== -1) {
                const newQuantity = materials[materialIndex].quantidade + change;

                // Garantir que a quantidade n√£o seja negativa
                if (newQuantity < 0) {
                    showFeedback("Quantidade n√£o pode ser negativa!", "error");
                    return;
                }

                materials[materialIndex].quantidade = newQuantity;

                try {
                    // Atualizar no Firebase
                    await db.collection("materials").doc(id).update({
                        quantidade: newQuantity,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Atualizar localmente
                    saveToLocalStorage();
                    renderMaterialsBySubcategory(currentCategory, currentSubcategory);

                    showFeedback(`Quantidade de ${materials[materialIndex].nome} atualizada!`, "success");

                    if (newQuantity === 0) {
                        showFeedback(`ATEN√á√ÉO: ${materials[materialIndex].nome} est√° sem estoque!`, "error");
                    }
                } catch (error) {
                    console.error("Erro ao atualizar quantidade:", error);
                    showFeedback("Erro de sincroniza√ß√£o. Tentando novamente...", "error");
                }
            }
        }

        // Mostrar feedback na tela
        function showFeedback(message, type) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = `feedback ${type}`;
            feedbackMessage.style.display = 'block';

            setTimeout(() => {
                feedbackMessage.style.display = 'none';
            }, 4000);
        }

        // Mostrar modal de PIN
        function showPinModal() {
            pinModal.style.display = 'flex';
            pinInput.focus();
        }

        // Esconder modal de PIN
        function hidePinModal() {
            pinModal.style.display = 'none';
            pinInput.value = '';
        }

        // Verificar PIN
        function verifyPin() {
            if (pinInput.value === ADMIN_PIN) {
                hidePinModal();
                showAdminScreen();
            } else {
                alert('PIN incorreto! Tente novamente.');
                pinInput.value = '';
                pinInput.focus();
            }
        }

        // Mostrar tela de administra√ß√£o
        function showAdminScreen() {
            mainScreen.style.display = 'none';
            adminScreen.style.display = 'block';
            renderMaterialsList();
            resetForm();
        }

        // Mostrar tela principal
        function showMainScreen() {
            adminScreen.style.display = 'none';
            mainScreen.style.display = 'block';
            showCategoryView();
        }

        // Mostrar view de categorias
        function showCategoryView() {
            categoryView.style.display = 'block';
            subcategoryView.style.display = 'none';
            materialsView.style.display = 'none';
        }

        // Mostrar view de subcategorias
        function showSubcategoryView() {
            categoryView.style.display = 'none';
            subcategoryView.style.display = 'block';
            materialsView.style.display = 'none';
        }

        // Mostrar view de materiais
        function showMaterialsView() {
            categoryView.style.display = 'none';
            subcategoryView.style.display = 'none';
            materialsView.style.display = 'block';
        }

        // Popular selects de categoria e subcategoria
        function populateCategorySelects() {
            categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';

            Object.keys(categoriesData).forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        // Atualizar select de subcategorias baseado na categoria selecionada
        function updateSubcategorySelect(category) {
            subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';

            if (category && categoriesData[category]) {
                Object.keys(categoriesData[category]).forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        // Renderizar lista de materiais na tela de administra√ß√£o
        function renderMaterialsList() {
            materialsListContainer.innerHTML = '';

            if (materials.length === 0) {
                materialsListContainer.innerHTML = '<p>Nenhum material cadastrado.</p>';
                return;
            }

            materials.forEach(material => {
                const item = document.createElement('div');
                item.className = 'material-item';

                item.innerHTML = `
                    <div class="material-details">
                        <div class="material-name">${material.nome}</div>
                        <div class="material-category">${material.categoria} - ${material.subcategoria} - ${material.quantidade} unidades</div>
                    </div>
                    <div class="material-actions-admin">
                        <button class="btn btn-edit" data-id="${material.id}">Editar</button>
                        <button class="btn btn-delete" data-id="${material.id}">Excluir</button>
                    </div>
                `;

                materialsListContainer.appendChild(item);
            });

            // Adicionar event listeners aos bot√µes
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = this.getAttribute('data-id');
                    editMaterial(id);
                });
            });

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = this.getAttribute('data-id');
                    deleteMaterial(id);
                });
            });
        }

        // Manipular envio do formul√°rio
        async function handleMaterialSubmit(e) {
            e.preventDefault();

            const id = materialIdInput.value || `local-${Date.now()}`;
            const name = document.getElementById('material-name').value;
            const category = document.getElementById('material-category').value;
            const subcategory = document.getElementById('material-subcategory').value;
            const quantity = parseInt(document.getElementById('material-quantity').value);
            const image = document.getElementById('material-image').value;
            const notes = document.getElementById('material-notes').value;

            const materialData = {
                id: id,
                nome: name,
                categoria: category,
                subcategoria: subcategory,
                quantidade: quantity,
                imagem: image,
                observacoes: notes
            };

            try {
                if (editingMaterialId !== null) {
                    // Atualizar material existente
                    materialData.id = editingMaterialId;
                    await saveMaterial(materialData);
                    showFeedback(`Material "${name}" atualizado com sucesso!`, "success");
                } else {
                    // Adicionar novo material
                    const newId = await saveMaterial(materialData);
                    showFeedback(`Material "${name}" cadastrado com sucesso!`, "success");
                }

                // Os dados ser√£o atualizados automaticamente pelo listener do Firebase
                resetForm();

            } catch (error) {
                console.error("Erro ao salvar material:", error);
                showFeedback("Erro ao salvar material. Verifique a conex√£o.", "error");
            }
        }

        // Editar material
        function editMaterial(id) {
            const material = materials.find(m => m.id === id);
            if (material) {
                document.getElementById('material-id').value = material.id;
                document.getElementById('material-name').value = material.nome;
                document.getElementById('material-category').value = material.categoria;
                updateSubcategorySelect(material.categoria);
                document.getElementById('material-subcategory').value = material.subcategoria;
                document.getElementById('material-quantity').value = material.quantidade;
                document.getElementById('material-image').value = material.imagem || '';
                document.getElementById('material-notes').value = material.observacoes || '';

                editingMaterialId = id;
                formTitle.textContent = 'Editar Material';
                submitBtn.textContent = 'Atualizar Material';
                cancelEditBtn.style.display = 'inline-block';

                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Cancelar edi√ß√£o
        function cancelEdit() {
            resetForm();
        }

        // Resetar formul√°rio
        function resetForm() {
            materialForm.reset();
            materialIdInput.value = '';
            editingMaterialId = null;
            formTitle.textContent = 'Cadastrar Novo Material';
            submitBtn.textContent = 'Cadastrar Material';
            cancelEditBtn.style.display = 'none';
            updateSubcategorySelect('');
        }

        // Excluir material
        async function deleteMaterial(id) {
            const material = materials.find(m => m.id === id);
            if (material && confirm(`Tem certeza que deseja excluir o material "${material.nome}"?`)) {
                try {
                    await deleteMaterialFromFirebase(id);
                    showFeedback(`Material "${material.nome}" exclu√≠do com sucesso!`, "success");
                } catch (error) {
                    console.error("Erro ao excluir material:", error);
                    showFeedback("Erro ao excluir material. Verifique a conex√£o.", "error");
                }
            }
        }
    </script>
</body>

</html>